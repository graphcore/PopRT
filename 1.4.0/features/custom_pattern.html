<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.10. Custom patterns &mdash; Title</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/table_styling.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom_rtd.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/js/graphcore.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5.11. Custom transforms" href="custom_transform.html" />
    <link rel="prev" title="5.9. Custom passes" href="custom_onnx_pass.html" />
     
    <script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1074732,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
    </script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PX5BPGW');</script>
    <!-- End Google Tag Manager -->

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

  
  <a href="https://docs.graphcore.ai/" class="icon icon-home" title="Back to Documents Home"><img src="../_static/graphcorelogo-html.png" class="logo" alt="Logo"/></a>


<div class="homelink"><a href="../index.html">POPRT USER GUIDE</a></div>


  
  
    <div class="version">
      Version: 1.4.0
    </div>
  



<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">1. 简介</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#id2">1.1. 背景</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#id3">1.2. 架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#id4">1.3. 工作流程</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">2. 安装</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#poprt-poplar-sdk">2.1. PopRT 和 Poplar SDK 版本的对应关系</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#docker">2.2. 从 Docker 镜像快速开始</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#host-poprt">2.3. 在 Host 上安装 PopRT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#for-ubuntu-20-04">2.3.1. For Ubuntu 20.04</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">3. 快速开始</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quick_start.html#id2">3.1. 主要参数介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quick_start.html#id3">3.2. 转换并运行模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quick_start.html#onnx">3.2.1. 下载 ONNX 模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start.html#id4">3.2.2. 获取 ONNX 模型输入输出信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start.html#shape">3.2.3. 指定输入 shape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start.html#id5">3.2.4. 指定模型精度</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start.html#id6">3.2.5. 运行模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start.html#popef">3.2.6. 导出 PopEF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../quick_start.html#id7">3.3. 快速部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quick_start.html#id8">3.3.1. 运行导出的 PopEF</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start.html#id9">3.3.2. 运行转换后的 ONNX 模型</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../quick_start.html#python-api">3.4. Python API 示例</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../instructions.html">4. 使用 PopRT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../instructions.html#id1">4.1. 使用方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../instructions.html#cli">4.1.1. CLI 使用</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../instructions.html#Named Arguments">Named Arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="../instructions.html#Sub-commands:">Sub-commands:</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../instructions.html#tf2onnx">tf2onnx</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">5. Features</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="passes.html">5.1. Passes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="passes.html#pass">5.1.1. Pass 抽象</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="fp8.html">5.2. FP8</a><ul>
<li class="toctree-l3"><a class="reference internal" href="fp8.html#ipu-fp8">5.2.1. IPU FP8 类型介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="fp8.html#id1">5.2.2. FP8 量化介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="fp8.html#fp32-fp8">5.2.3. FP32 模型转 FP8 模型的流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="fp8.html#id2">5.2.4. FP8 模型转换工具使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="fp8.html#id3">5.2.5. FP8 模型转换精度调试经验</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="overlap_io.html">5.3. Overlap I/O</a><ul>
<li class="toctree-l3"><a class="reference internal" href="overlap_io.html#id1">5.3.1. 原理</a></li>
<li class="toctree-l3"><a class="reference internal" href="overlap_io.html#io-tiles">5.3.2. 配置 IO Tiles</a></li>
<li class="toctree-l3"><a class="reference internal" href="overlap_io.html#id2">5.3.3. 调试</a></li>
<li class="toctree-l3"><a class="reference internal" href="overlap_io.html#id3">5.3.4. 并发请求</a></li>
<li class="toctree-l3"><a class="reference internal" href="overlap_io.html#id4">5.3.5. 示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="dynamic_batch_size.html">5.4. Dynamic batch size</a><ul>
<li class="toctree-l3"><a class="reference internal" href="dynamic_batch_size.html#id1">5.4.1. 背景</a></li>
<li class="toctree-l3"><a class="reference internal" href="dynamic_batch_size.html#id3">5.4.2. 示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="packing.html">5.5. Packing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="packing.html#id1">5.5.1. 背景</a></li>
<li class="toctree-l3"><a class="reference internal" href="packing.html#packing-unpacking">5.5.2. Packing 及 unpacking</a></li>
<li class="toctree-l3"><a class="reference internal" href="packing.html#transformer-based-nlp-models">5.5.3. Transformer-based NLP models</a></li>
<li class="toctree-l3"><a class="reference internal" href="packing.html#id2">5.5.4. 如何使用 packing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="packing.html#id3">下载模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="packing.html#id4">转换模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="packing.html#id5">运行模型</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cpu_packing.html">5.6. CPU packing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cpu_packing.html#id1">5.6.1. 背景</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpu_packing.html#id2">5.6.2. 功能模块介绍</a><ul>
<li class="toctree-l4"><a class="reference internal" href="cpu_packing.html#id3">1. 超时处理</a></li>
<li class="toctree-l4"><a class="reference internal" href="cpu_packing.html#id4">2. 用户数据预处理</a></li>
<li class="toctree-l4"><a class="reference internal" href="cpu_packing.html#id5">3. 数据累积</a></li>
<li class="toctree-l4"><a class="reference internal" href="cpu_packing.html#pack">4. Pack 后处理</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="cpu_packing.html#id6">5.6.3. Pack 算法</a><ul>
<li class="toctree-l4"><a class="reference internal" href="cpu_packing.html#id7">1. 首尾相连的 pack 方法</a></li>
<li class="toctree-l4"><a class="reference internal" href="cpu_packing.html#firstfit-pack">2. FirstFit pack 方法</a></li>
<li class="toctree-l4"><a class="reference internal" href="cpu_packing.html#nextfit-pack">3. NextFit pack 方法</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="cpu_packing.html#id8">5.6.4. 示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="model_fusion.html">5.7. Model fusion</a><ul>
<li class="toctree-l3"><a class="reference internal" href="model_fusion.html#poprt">5.7.1. 实现 PopRT 模型融合</a></li>
<li class="toctree-l3"><a class="reference internal" href="model_fusion.html#id1">5.7.2. 实现 PopRT runtime 融合模型推理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="custom_ops.html">5.8. Custom operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="custom_ops.html#id1">5.8.1. 编写自定义算子</a><ul>
<li class="toctree-l4"><a class="reference internal" href="custom_ops.html#leakyrelu-op-onnx">创建一个带有 <code class="docutils literal notranslate"><span class="pre">LeakyRelu</span></code> OP 的 ONNX 模型文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom_ops.html#poprt">在 PopRT 中使用自定义算子</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="custom_onnx_pass.html">5.9. Custom passes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="custom_onnx_pass.html#id1">5.9.1. 实现 custom passes</a></li>
<li class="toctree-l3"><a class="reference internal" href="custom_onnx_pass.html#id2">5.9.2. 使用 custom passes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="custom_onnx_pass.html#poprt-cli-custom-passes">在 PopRT CLI 中使用 custom passes</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom_onnx_pass.html#python-api-custom-passes">在 Python API 中使用 custom passes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.10. Custom patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-popart-patterns">5.10.1. 实现 custom PopART patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="#poprt-custom-popart-patterns">5.10.2. 在 PopRT 中使用 custom PopART patterns</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#patterncreator-pattern">方法一: 在 <code class="docutils literal notranslate"><span class="pre">PatternCreator</span></code> 设置 pattern 默认使能</a></li>
<li class="toctree-l4"><a class="reference internal" href="#python-api-pattern">方法二: 使用 Python API 启用或关闭指定的 pattern</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cli-pattern">方法三: 通过 CLI 命令行参数启用或关闭指定的 pattern</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="custom_transform.html">5.11. Custom transforms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="custom_transform.html#custom-popart-transform">5.11.1. 实现 custom PopART transform</a></li>
<li class="toctree-l3"><a class="reference internal" href="custom_transform.html#poprt-custom-transform">5.11.2. 在 PopRT 中使用 custom transform</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="manual_sharding.html">5.12. Manual sharding</a><ul>
<li class="toctree-l3"><a class="reference internal" href="manual_sharding.html#sharding">5.12.1. Sharding / 模型并行</a></li>
<li class="toctree-l3"><a class="reference internal" href="manual_sharding.html#pipelining">5.12.2. Pipelining / 流水线并行</a></li>
<li class="toctree-l3"><a class="reference internal" href="manual_sharding.html#id3">5.12.3. Manual sharding 流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="manual_sharding.html#id4">5.12.4. 配置 manual sharding</a><ul>
<li class="toctree-l4"><a class="reference internal" href="manual_sharding.html#poprt-cli-manual-sharding">通过 PopRT CLI 配置 manual sharding</a></li>
<li class="toctree-l4"><a class="reference internal" href="manual_sharding.html#poprt-converter-sharder-api-manual-sharding">通过 <code class="docutils literal notranslate"><span class="pre">poprt.converter.Sharder</span></code> API 配置 manual sharding</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="manual_sharding.html#id5">5.12.5. 示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="error_handling.html">5.13. Error handling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="error_handling.html#id1">5.13.1. 背景</a></li>
<li class="toctree-l3"><a class="reference internal" href="error_handling.html#id2">5.13.2. 相关的错误处理方式</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html">5.14. PopRT frontend</a><ul>
<li class="toctree-l3"><a class="reference internal" href="frontend.html#onnx-frontend">5.14.1. ONNX frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="frontend.html#tensorflow-frontend">5.14.2. TensorFlow frontend</a><ul>
<li class="toctree-l4"><a class="reference internal" href="frontend.html#poprt-cli-tensorflow">通过 PopRT CLI 加载 TensorFlow 模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="frontend.html#poprt-frontend-api-tensorflow">通过 <code class="docutils literal notranslate"><span class="pre">poprt.frontend</span></code> API 加载 TensorFlow 模型</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="auto_sharding.html">5.15. Auto sharding</a><ul>
<li class="toctree-l3"><a class="reference internal" href="auto_sharding.html#id1">5.15.1. 模型并行</a></li>
<li class="toctree-l3"><a class="reference internal" href="auto_sharding.html#id2">5.15.2. Auto sharding 原理介绍</a><ul>
<li class="toctree-l4"><a class="reference internal" href="auto_sharding.html#id3">备选点策略</a></li>
<li class="toctree-l4"><a class="reference internal" href="auto_sharding.html#id4">切分方案遍历策略</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="auto_sharding.html#id5">5.15.3. Auto sharding 使用方法</a><ul>
<li class="toctree-l4"><a class="reference internal" href="auto_sharding.html#id6">参数介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="auto_sharding.html#id7">举例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="model_debugger.html">5.16. Model debugger</a><ul>
<li class="toctree-l3"><a class="reference internal" href="model_debugger.html#id1">5.16.1. 使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="model_debugger.html#id2">5.16.2. 使用示例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../python_api.html">6. Python API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../python_api.html#poprt-module">6.1. <code class="docutils literal notranslate"><span class="pre">poprt</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python_api.html#poprt-compiler-module">6.2. <code class="docutils literal notranslate"><span class="pre">poprt.compiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python_api.html#poprt-runtime-module">6.3. <code class="docutils literal notranslate"><span class="pre">poprt.runtime</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python_api.html#poprt-frontend-module">6.4. <code class="docutils literal notranslate"><span class="pre">poprt.frontend</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python_api.html#poprt-backends-module">6.5. <code class="docutils literal notranslate"><span class="pre">poprt.backends</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python_api.html#poprt-quantizer-module">6.6. <code class="docutils literal notranslate"><span class="pre">poprt.quantizer</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python_api.html#poprt-passes-module">6.7. <code class="docutils literal notranslate"><span class="pre">poprt.passes</span></code> module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../python_api.html#built-in-passes">6.7.1. Built-in passes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cxx_api.html">7. C++ API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cxx_api.html#poprt-compiler">7.1. PopRT compiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cxx_api.html#executable">7.2. Executable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cxx_api.html#poprt-runtime">7.3. PopRT runtime</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../cxx_api.html#devicemanager">7.3.1. DeviceManager</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../history.html">8. 文档修订记录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legal.html">9. Trademarks &amp; copyright</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">POPRT USER GUIDE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="custom-patterns">
<span id="features-custom-pattern"></span><h1><span class="section-number">5.10. </span>Custom patterns<a class="headerlink" href="#custom-patterns" title="Permalink to this headline"></a></h1>
<p>Pattern 的概念来源于 PopART 框架, pattern 的作用是在 PopART IR 上对 OP 做匹配, 并对匹配到的 OP 进行修改或替换, 是图优化的一种手段.
对于 custom PopART pattern, 典型的应用场景是, 用户实现了某个高性能 OP, 并通过 custom PopART pattern 把某些有性能瓶颈的 OP 替换成这个高性能 OP, 从而提高整个模型的性能.</p>
<p>本章帮助用户了解如何实现 custom PopART patterns 并在 PopRT 中使用.</p>
<p>在阅读本教程之前, 需要首先了解以下主题:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.graphcore.ai/projects/popart-user-guide/en/latest/index.html">PopART 用户指南</a></p></li>
</ul>
<section id="custom-popart-patterns">
<h2><span class="section-number">5.10.1. </span>实现 custom PopART patterns<a class="headerlink" href="#custom-popart-patterns" title="Permalink to this headline"></a></h2>
<p>要在 PopRT 中实现一个 custom PopART pattern, 需要编写至少一个 C++ 文件.</p>
<p>示例代码如下, 这个例子将图中的 Relu Op 替换为 Negtive Op, 可以将它编译成独立的动态库并在使用 PopRT 的时候链接:</p>
<div class="literal-block-wrapper docutils container" id="replace-relu-with-neg-pattern-cpp">
<div class="code-block-caption"><span class="caption-number">Listing 5.15 </span><span class="caption-text">replace_relu_with_neg_pattern.cpp</span><a class="headerlink" href="#replace-relu-with-neg-pattern-cpp" title="Permalink to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Copyright (c) 2022 Graphcore Ltd. All rights reserved.</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;popart/graph.hpp&gt;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;popart/op/negate.hpp&gt;</span>
<span class="linenos"> 6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;popart/op/relu.hpp&gt;</span>
<span class="linenos"> 7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;popart/op/sqrt.hpp&gt;</span>
<span class="linenos"> 8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;popart/operators.hpp&gt;</span>
<span class="linenos"> 9</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;popart/patterns/pattern.hpp&gt;</span>
<span class="linenos">10</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;popart/patterns/patterns.hpp&gt;</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="k">namespace</span><span class="w"> </span><span class="nn">popart</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">13</span><span class="k">class</span><span class="w"> </span><span class="nc">IArray</span><span class="p">;</span>
<span class="linenos">14</span><span class="k">class</span><span class="w"> </span><span class="nc">Tensor</span><span class="p">;</span>
<span class="linenos">15</span><span class="p">}</span><span class="w"> </span><span class="c1">// namespace popart</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">popart</span><span class="p">;</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="k">class</span><span class="w"> </span><span class="nc">ReplaceReluWithNeg</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">PreAliasPattern</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">20</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">21</span><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">matches</span><span class="p">(</span><span class="n">Op</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">isConvertibleTo</span><span class="o">&lt;</span><span class="n">ReluOp</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Tensor</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">touches</span><span class="p">(</span><span class="n">Op</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{};</span><span class="w"> </span><span class="p">}</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">Op</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">26</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Custom pattern ReplaceReluWithNeg applied in &quot;</span>
<span class="linenos">27</span><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">debugName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">negOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makeReplacementOpInIr</span><span class="p">(</span><span class="n">Onnx</span><span class="o">::</span><span class="n">Operators</span><span class="o">::</span><span class="n">Neg_6</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">inputId</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">inId</span><span class="p">(</span><span class="n">ReluOp</span><span class="o">::</span><span class="n">getInIndex</span><span class="p">());</span>
<span class="linenos">32</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">outputId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">outId</span><span class="p">(</span><span class="n">ReluOp</span><span class="o">::</span><span class="n">getOutIndex</span><span class="p">());</span>
<span class="linenos">33</span><span class="w">    </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">disconnectAllInputs</span><span class="p">();</span>
<span class="linenos">34</span><span class="w">    </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">disconnectAllOutputs</span><span class="p">();</span>
<span class="linenos">35</span><span class="w">    </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">getGraph</span><span class="p">().</span><span class="n">eraseOp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="w">    </span><span class="n">negOp</span><span class="o">-&gt;</span><span class="n">connectInTensor</span><span class="p">(</span><span class="n">NegateOp</span><span class="o">::</span><span class="n">getInIndex</span><span class="p">(),</span><span class="w"> </span><span class="n">inputId</span><span class="p">);</span>
<span class="linenos">38</span><span class="w">    </span><span class="n">negOp</span><span class="o">-&gt;</span><span class="n">connectOutTensor</span><span class="p">(</span><span class="n">NegateOp</span><span class="o">::</span><span class="n">getOutIndex</span><span class="p">(),</span><span class="w"> </span><span class="n">outputId</span><span class="p">);</span>
<span class="linenos">39</span><span class="w">    </span><span class="n">negOp</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">();</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">42</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">43</span><span class="p">};</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="k">namespace</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">46</span><span class="k">static</span><span class="w"> </span><span class="n">PatternCreator</span><span class="o">&lt;</span><span class="n">ReplaceReluWithNeg</span><span class="o">&gt;</span>
<span class="linenos">47</span><span class="w">    </span><span class="n">ReplaceReluWithNegPatternCreator</span><span class="p">(</span><span class="s">&quot;ReplaceReluWithNeg&quot;</span><span class="p">,</span>
<span class="linenos">48</span><span class="w">                                     </span><span class="cm">/* default enabled = */</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span>
<span class="linenos">49</span><span class="w">                                     </span><span class="cm">/* default mandatory = */</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="linenos">50</span><span class="p">}</span><span class="w"> </span><span class="c1">// namespace</span>
</pre></div>
</div>
</div>
<p>实现 custom PopART patterns, 通常需要实现以下两个部分:</p>
<ul class="simple">
<li><p>继承 <code class="docutils literal notranslate"><span class="pre">PreAliasPattern</span></code> 并实现其 <code class="docutils literal notranslate"><span class="pre">apply</span></code> 方法.</p></li>
<li><p>通过 <code class="docutils literal notranslate"><span class="pre">PatternCreator</span></code> 注册该 pattern.</p></li>
</ul>
</section>
<section id="poprt-custom-popart-patterns">
<h2><span class="section-number">5.10.2. </span>在 PopRT 中使用 custom PopART patterns<a class="headerlink" href="#poprt-custom-popart-patterns" title="Permalink to this headline"></a></h2>
<p>首先需要把 pattern 的源码编译成动态链接库, 编译的命令示例如下:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">g++ \</span>
<span class="go">    -std=c++14 \</span>
<span class="go">    -fPIC \</span>
<span class="go">    -O3 \</span>
<span class="go">    -DONNX_NAMESPACE=onnx \</span>
<span class="go">    replace_relu_with_neg_pattern.cpp \</span>
<span class="go">    -shared \</span>
<span class="go">    -lpopart \</span>
<span class="go">    -o custom_pattern.so</span>
</pre></div>
</div>
<p>然后可以通过 PopRT CLI 的 <code class="docutils literal notranslate"><span class="pre">--custom_library_so_paths</span></code> 参数来链接包含 custom patterns 的动态库:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">poprt  --custom_library_so_paths path/to/shared/library</span>
</pre></div>
</div>
<p>目前有以下几种方法可以在 PopRT 中使用 custom PopART patterns. 设置 pattern 时, pattern 名称后可以使用 <code class="docutils literal notranslate"><span class="pre">:value</span></code> 指定是否关闭或启用该 pattern. 其中:</p>
<ul class="simple">
<li><p>如果 pattern 名称后没有使用 <code class="docutils literal notranslate"><span class="pre">:value</span></code>, 则启用该 pattern.</p></li>
<li><p>如果 pattern 名称后指定了 <code class="docutils literal notranslate"><span class="pre">:value</span></code>, 且 <code class="docutils literal notranslate"><span class="pre">value</span></code> 的值为 <code class="docutils literal notranslate"><span class="pre">True</span></code>, <code class="docutils literal notranslate"><span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">1</span></code> 其中的一个, 则启用该 pattern.</p></li>
<li><p>否则为关闭该 pattern.</p></li>
</ul>
<section id="patterncreator-pattern">
<h3>方法一: 在 <code class="docutils literal notranslate"><span class="pre">PatternCreator</span></code> 设置 pattern 默认使能<a class="headerlink" href="#patterncreator-pattern" title="Permalink to this headline"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">PatternCreator</span><span class="o">&lt;</span><span class="n">ReplaceReluWithNeg</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">ReplaceReluWithNegPatternCreator</span><span class="p">(</span><span class="s">&quot;ReplaceReluWithNeg&quot;</span><span class="p">,</span>
<span class="w">                                    </span><span class="cm">/* default enabled = */</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
</pre></div>
</div>
<p>这种方法在编译期就确定 pattern 的使用, 在链接这个 pattern 的动态库之后会默认执行, 无法在运行时动态控制关闭.</p>
</section>
<section id="python-api-pattern">
<h3>方法二: 使用 Python API 启用或关闭指定的 pattern<a class="headerlink" href="#python-api-pattern" title="Permalink to this headline"></a></h3>
<p>Python 使用 <code class="docutils literal notranslate"><span class="pre">CompilerOptions().custom_patterns</span></code> 接口设置 pattern. 如下案例中, 启用了 <code class="docutils literal notranslate"><span class="pre">ReplaceReluWithNeg</span></code> pattern, 并关闭 <code class="docutils literal notranslate"><span class="pre">InPlace</span></code> pattern.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">poprt.compiler</span> <span class="kn">import</span> <span class="n">Compiler</span><span class="p">,</span> <span class="n">CompilerOptions</span>

<span class="n">opts</span> <span class="o">=</span> <span class="n">CompilerOptions</span><span class="p">()</span>
<span class="n">opts</span><span class="o">.</span><span class="n">custom_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ReplaceReluWithNeg&quot;</span><span class="p">,</span> <span class="s2">&quot;InPlace:0&quot;</span><span class="p">]</span>
<span class="n">Compiler</span><span class="o">.</span><span class="n">compile_and_export</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">popef_path</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="cli-pattern">
<h3>方法三: 通过 CLI 命令行参数启用或关闭指定的 pattern<a class="headerlink" href="#cli-pattern" title="Permalink to this headline"></a></h3>
<p>CLI 指定 pattern 时, 多个 pattern 可以使用逗号 <code class="docutils literal notranslate"><span class="pre">,</span></code> 隔开. 如下案例中, 启用了 <code class="docutils literal notranslate"><span class="pre">ReplaceReluWithNeg</span></code> pattern, 并关闭 <code class="docutils literal notranslate"><span class="pre">InPlace</span></code> pattern.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">poprt \</span>
<span class="go">    --input_model model.onnx \</span>
<span class="go">    --output_model model_export.onnx \</span>
<span class="go">    --export_popef \</span>
<span class="go">    --output_dir model \</span>
<span class="go">    --custom_library_so_paths build/custom_patterns.so \</span>
<span class="go">    --compiler_options custom_patterns=ReplaceReluWithNeg,InPlace:0</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="custom_onnx_pass.html" class="btn btn-neutral float-left" title="5.9. Custom passes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="custom_transform.html" class="btn btn-neutral float-right" title="5.11. Custom transforms" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
     
    <script id="hs-script-loader" async defer src="//js.hs-scripts.com/729091.js"></script>
    <script defer>
        if (typeof mutationObserver !== 'undefined')
            mutationObserver.observe(document.querySelector("div.rst-other-versions"), {childList: true, subtree: true})
        if (typeof updateDocumentLinks !== 'undefined')
            updateDocumentLinks()
        let search = document.querySelector("form#rtd-search-form > input[name='q']")
        if (document.location.pathname.startsWith("/projects/"))
          search.placeholder = "Search this document";
        else
          search.placeholder = "Search all documents";
    </script>


</body>
</html>